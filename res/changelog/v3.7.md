fix critical bug that led to the undo feature not working properly (#849)
